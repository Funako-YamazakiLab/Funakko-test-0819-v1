<!doctype html>
<html lang="ja" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>Pico2 Blockly → MicroPython（Start/Stopボタン＋自動初期化）</title>

  <!-- Blockly 同一バージョン -->
  <script src="https://cdn.jsdelivr.net/npm/blockly@10.4.3/blockly.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/blockly@10.4.3/blocks_compressed.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/blockly@10.4.3/python_compressed.js"></script>

  <style>
    :root{
      --accent:#4f8ef7; --bg:#f7f8fb; --card:#ffffff; --border:#e5e7ef; --text:#222; --muted:#6b7280;
      --start:#10b981; --start-border:#059669;
      --stop:#ef4444;  --stop-border:#dc2626;
    }
    html, body { height:100%; overflow:hidden; }
    body{
      margin:0; background:var(--bg);
      display:grid; grid-template-columns:360px 1fr; height:100vh;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; color:var(--text);
    }
    #side{ padding:14px; border-right:1px solid var(--border); display:flex; flex-direction:column; gap:10px; background:linear-gradient(#fff,#fafbff); }
    #ws{ width:100%; height:100vh; }
    h3{ margin:4px 0 0; font-weight:700; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    button{
      padding:9px 12px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:700;
      transition:.15s ease background,.15s ease transform;
    }
    button:hover{ transform:translateY(-1px); }
    button:disabled{ opacity:.5; cursor:not-allowed; transform:none; }

    .start{ background:var(--start); border-color:var(--start-border); color:#fff; }
    .start:hover{ background:var(--start-border); }
    .stop{  background:var(--stop);  border-color:var(--stop-border);  color:#fff; }
    .stop:hover{  background:var(--stop-border); }

    pre{ background:#0b1220; color:#a7ffb7; padding:10px; height:26vh; overflow:auto; border-radius:10px; box-shadow:inset 0 0 0 1px #0f172a; }
    .console{
      background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:10px;
      padding:10px 12px; height:26vh; overflow:auto; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Roboto Mono",monospace;
      font-size:14px; line-height:1.4; box-shadow:0 1px 4px rgba(0,0,0,.04) inset;
    }
    .console .line{ padding:2px 0; border-bottom:1px dashed #eef0f6; }
    .console .line:last-child{ border-bottom:none; }

    .blocklyWidgetDiv, .blocklyDropDownDiv, .blocklyBubbleCanvas{ z-index: 9999 !important; pointer-events: auto !important; }
    .blocklyMainBackground{ fill:#fbfcff; }
    .blocklyToolboxDiv{ border-left:1px solid var(--border); }
    .blocklyTreeLabel{ font-weight:600; }
  </style>
</head>
<body>
  <div id="side">
    <h3>Blockly → MicroPython</h3>
    <div class="row">
      <button id="btnConnect">🔌 接続</button>
      <button id="btnStart" class="start" disabled>▶ スタート</button>
      <button id="btnStop"  class="stop"  disabled>■ ストップ</button>
      <button id="btnGen">🧪 コードを表示</button>
      <button id="btnReset">🔄 リセット</button>
    </div>

    <pre id="out"># ここにMicroPythonコードが表示されます</pre>

    <div style="display:flex; align-items:center; justify-content:space-between; gap:6px;">
      <strong>シリアルモニター</strong>
      <button id="btnConsoleClear" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer;">クリア</button>
    </div>
    <div id="console" class="console" aria-live="polite" aria-label="シリアルモニター出力"></div>

    <small>
      ・超音波・VEML6040・Start/Stopボタン・モータは<strong>自動初期化</strong>（コード内）。初期化ブロックはありません。<br/>
      ・モータ既定: IN1=0, IN2=1, IN3=2, IN4=10／超音波: trig=20, echo=21／ボタン: Start=8, Stop=9／VEML: SDA=4, SCL=5, IT=320ms
    </small>
  </div>

  <div id="ws" aria-label="Blockly workspace"></div>

  <script>
    // ========= テーマ色 =========
    const Colours = {
      control:  '#f59e0b',
      logic:    '#16a34a',
      vars:     '#f97316',
      display:  '#8b5cf6',
      gpio:     '#06b6d4',
      motor:    '#ef4444',
      button:   '#f43f5e',
      ultra:    '#0ea5e9',
      veml:     '#a855f7'
    };
    const KiddoTheme = Blockly.Theme.defineTheme('kiddo', {
      base: Blockly.Themes.Classic,
      componentStyles: {
        workspaceBackgroundColour:'#fbfcff',
        toolboxBackgroundColour:'#ffffff',
        flyoutBackgroundColour:'#f7f8fb',
        flyoutOpacity:1
      }
    });

    // ========= 1) ブロック定義（start_ja / end_ja なし） =========
    Blockly.defineBlocksWithJsonArray([
      // --- 論理 ---
      {"type":"logic_andor_ja","message0":"%1 %2 %3",
       "args0":[
         {"type":"input_value","name":"A","check":"Boolean"},
         {"type":"field_dropdown","name":"OP","options":[["かつ","and"],["または","or"]]},
         {"type":"input_value","name":"B","check":"Boolean"}],
       "inputsInline":true,"output":"Boolean","colour":Colours.logic},
      {"type":"logic_not_ja","message0":"%1 ではない ",
       "args0":[{"type":"input_value","name":"X","check":"Boolean"}],
       "inputsInline":true,"output":"Boolean","colour":Colours.logic},

      // --- 制御（開始/終了なし） ---
      {"type":"forever_ja","message0":"ずっと くりかえす","message1":"やること %1","args1":[{"type":"input_statement","name":"DO"}],"previousStatement":null,"nextStatement":null,"colour":Colours.control},
      {"type":"repeat_ja","message0":"くりかえす %1 回","args0":[{"type":"input_value","name":"TIMES","check":"Number"}],"message1":"やること %1","args1":[{"type":"input_statement","name":"DO"}],"previousStatement":null,"nextStatement":null,"colour":Colours.control},
      {"type":"time_wait_ms","message0":"待つ (ミリ秒) %1","args0":[{"type":"input_value","name":"MS","check":"Number"}],"previousStatement":null,"nextStatement":null,"colour":Colours.control},

      // --- かんたん条件 ---
      {"type":"if_simple_ja","message0":"もし %1 なら",
       "args0":[{"type":"input_value","name":"COND"}],
       "message1":"やること %1","args1":[{"type":"input_statement","name":"DO"}],
       "previousStatement":null,"nextStatement":null,"colour":Colours.control},
      {"type":"if_else_simple_ja","message0":"もし %1 なら",
       "args0":[{"type":"input_value","name":"COND"}],
       "message1":"やること %1","args1":[{"type":"input_statement","name":"DO"}],
       "message2":"それ以外なら %1","args2":[{"type":"input_statement","name":"ELSE"}],
       "previousStatement":null,"nextStatement":null,"colour":Colours.control},

      // --- 表示 ---
      {"type":"print_ja","message0":"表示 %1","args0":[{"type":"input_value","name":"VAL"}],"previousStatement":null,"nextStatement":null,"colour":Colours.display},

      // --- GPIO ---
      {"type":"gpio_set","message0":"ピン %1 を %2",
       "args0":[{"type":"input_value","name":"PIN","check":"Number"},{"type":"field_dropdown","name":"VAL","options":[["ON","1"],["OFF","0"]]}],
       "previousStatement":null,"nextStatement":null,"colour":Colours.gpio},

      // --- モータ（自動初期化・コマンドのみ） ---
      // --- モータ（自動初期化・コマンドのみ） ---
        {"type":"motor_cmd","message0":"ローバを %1 する",
        "args0":[{"type":"field_dropdown","name":"CMD","options":[
        ["前進","forward"],
        ["後退","backward"],
        ["左回転","left"],
        ["右回転","right"],
        ["右後ろ回旋","back_right_rotate"],   // ← 追加
        ["左後ろ回旋","back_left_rotate"],    // ← 追加
        ["停止","stopMotors"]
        ]}],
        "previousStatement":null,"nextStatement":null,"colour":Colours.motor},


      // --- センサー ---
      {"type":"ultra_read_cm","message0":"超音波　距離(cm)","output":"Number","colour":Colours.ultra},
      {"type":"veml_value","message0":"カラーセンサの %1 の値",
       "args0":[{"type":"field_dropdown","name":"KIND","options":[["赤","R"],["緑","G"],["青","B"],["白","W"],["照度(lux)","LUX"],["色温度(K)","CCT"]]}],
       "output":"Number","colour":Colours.veml},

      // --- 変数・比較 ---
      {"type":"var_name","message0":"変数名 %1","args0":[{"type":"field_input","name":"VARNAME","text":"dist"}],"output":"VarName","colour":Colours.vars},
      {"type":"var_set_by_name","message0":"変数 %1 に %2 を入れる","args0":[{"type":"input_value","name":"NAME","check":"VarName"},{"type":"input_value","name":"VAL"}],"previousStatement":null,"nextStatement":null,"colour":Colours.vars},
      {"type":"var_get_by_name","message0":"変数 %1 の値","args0":[{"type":"input_value","name":"NAME","check":"VarName"}],"output":null,"colour":Colours.vars},
      {"type":"var_compare","message0":"変数 %1 が %2 %3","args0":[{"type":"input_value","name":"NAME","check":"VarName"},{"type":"field_dropdown","name":"OP","options":[["<","<"],["≤","<="],["==","=="],["≠","!="],["≥",">="],[">",">"]]}, {"type":"input_value","name":"RHS"}],"output":"Boolean","colour":Colours.logic},

      // --- ボタン ---
      {"type":"button_state","message0":"ボタン %1 が ON","args0":[{"type":"field_dropdown","name":"WHICH","options":[["Start(ON)","START"],["Stop(OFF)","STOP"]]}],"output":"Boolean","colour":Colours.button},

      // --- Flags ---
      {"type":"flag_set","message0":"フラッグ %1 を 立てる","args0":[{ "type":"field_input","name":"FLAG","text":"x" }],"previousStatement":null,"nextStatement":null,"colour": Colours.vars, "inputsInline": true},
      {"type":"flag_clear","message0":"フラッグ %1 を 下ろす","args0":[{ "type":"field_input","name":"FLAG","text":"x" }],"previousStatement":null,"nextStatement":null,"colour": Colours.vars, "inputsInline": true},
      {"type":"flag_toggle","message0":"フラッグ %1 を 切り替える","args0":[{ "type":"field_input","name":"FLAG","text":"x" }],"previousStatement":null,"nextStatement":null,"colour": Colours.vars, "inputsInline": true},
      {"type":"flag_is_set","message0":"フラッグ %1 が 立っている","args0":[{ "type":"field_input","name":"FLAG","text":"x" }],"output":"Boolean","colour": Colours.logic, "inputsInline": true}
    ]);

    // ========= 2) Python ジェネレーター（start_ja / end_ja なし） =========
    const py = Blockly.Python;

    // 論理
    py.forBlock['logic_andor_ja'] = (b,g)=>{
      const op = b.getFieldValue('OP') || 'and';
      const A  = g.valueToCode(b,'A', op==='and' ? py.ORDER_LOGICAL_AND : py.ORDER_LOGICAL_OR) || 'False';
      const B  = g.valueToCode(b,'B', op==='and' ? py.ORDER_LOGICAL_AND : py.ORDER_LOGICAL_OR) || 'False';
      return [`(${A} ${op} ${B})`, (op==='and')?py.ORDER_LOGICAL_AND:py.ORDER_LOGICAL_OR];
    };
    py.forBlock['logic_not_ja'] = (b,g)=>{
      const X = g.valueToCode(b,'X', py.ORDER_LOGICAL_NOT) || 'False';
      return [`(not ${X})`, py.ORDER_LOGICAL_NOT];
    };

    // 制御（開始／終了以外）
    py.forBlock['forever_ja'] = (b,g)=>{ const body=g.statementToCode(b,'DO')||'    pass\n'; return `while True:\n${body}`; };
    py.forBlock['repeat_ja']  = (b,g)=>{ const t=g.valueToCode(b,'TIMES',g.ORDER_NONE)||'0'; const body=g.statementToCode(b,'DO')||'    pass\n'; return `for _ in range(int(${t})):\n${body}`; };
    py.forBlock['time_wait_ms'] = (b,g)=>{ const ms=g.valueToCode(b,'MS',g.ORDER_NONE)||'1000'; return `time.sleep_ms(int(${ms}))\n`; };

    // かんたん条件
    py.forBlock['if_simple_ja'] = (b,g)=>{ const cond=g.valueToCode(b,'COND',g.ORDER_NONE)||'False'; const body=g.statementToCode(b,'DO')||'    pass\n'; return `if ${cond}:\n${body}`; };
    py.forBlock['if_else_simple_ja'] = (b,g)=>{ const cond=g.valueToCode(b,'COND',g.ORDER_NONE)||'False'; const a=g.statementToCode(b,'DO')||'    pass\n'; const bdy=g.statementToCode(b,'ELSE')||'    pass\n'; return `if ${cond}:\n${a}else:\n${bdy}`; };

    // 表示・GPIO
    py.forBlock['print_ja'] = (b,g)=>{ const v=g.valueToCode(b,'VAL',g.ORDER_NONE)||"''"; return `print(${v})\n`; };
    py.forBlock['gpio_set'] = (b,g)=>{ const pin=g.valueToCode(b,'PIN',g.ORDER_NONE)||'25'; const v=b.getFieldValue('VAL'); const p=/^\s*['"]/.test(pin)?pin:`int(${pin})`; return `Pin(${p}, Pin.OUT).value(${v})\n`; };

    // モータ
    py.forBlock['motor_cmd'] = b=> `${b.getFieldValue('CMD')}()\n`;

    // 超音波
    py.forBlock['ultra_read_cm'] = ()=>['ultra_read_cm()', py.ORDER_FUNCTION_CALL];

    // 変数
    const PY_KEYWORDS = new Set(["False","None","True","and","as","assert","async","await","break","class","continue","def","del","elif","else","except","finally","for","from","global","if","import","in","is","lambda","nonlocal","not","or","pass","raise","return","try","while","with","yield"]);
    const sanitizeIdent = raw => { raw=(raw||"").trim(); if(!raw) return "v"; let s=raw.replace(/[^A-Za-z0-9_]/g,"_"); if(!/^[A-Za-z_]/.test(s)) s="v_"+s; if(PY_KEYWORDS.has(s)) s+="_"; return s; };
    py.forBlock['var_name'] = b=>[sanitizeIdent(b.getFieldValue('VARNAME')), py.ORDER_ATOMIC];
    py.forBlock['var_set_by_name'] = (b,g)=>{ const n=g.valueToCode(b,'NAME',py.ORDER_ATOMIC)||'v'; const val=g.valueToCode(b,'VAL',py.ORDER_NONE)||'None'; return `${n} = ${val}\n`; };
    py.forBlock['var_get_by_name'] = (b,g)=>{ const n=g.valueToCode(b,'NAME',py.ORDER_ATOMIC)||'v'; return [n, py.ORDER_ATOMIC]; };
    py.forBlock['var_compare'] = (b,g)=>{ const n=g.valueToCode(b,'NAME',py.ORDER_ATOMIC)||'v'; const op=b.getFieldValue('OP')||'=='; const rhs=g.valueToCode(b,'RHS',py.ORDER_ATOMIC)||'0'; return [`(${n} ${op} ${rhs})`, py.ORDER_ATOMIC]; };

    // ボタン
    py.forBlock['button_state'] = b => {
      const which = b.getFieldValue('WHICH');
      const fn = (which === 'START') ? 'button_start()' : 'button_stop()';
      return [fn, py.ORDER_FUNCTION_CALL];
    };

    // VEML6040
    py.forBlock['veml_value'] = b=>{ const k=b.getFieldValue('KIND'); const m={R:'veml_red()',G:'veml_green()',B:'veml_blue()',W:'veml_white()',LUX:'veml_lux()',CCT:'veml_cct()'}; return [m[k]||'0', py.ORDER_FUNCTION_CALL]; };

    // ========= 3) ツールボックス（start_ja / end_ja を外す） =========
    const toolbox = {
      "kind": "flyoutToolbox",
      "contents": [
        { "kind":"label", "text":"論理（AND/OR/NOT）" },
        { "kind":"block", "type":"logic_andor_ja" },
        { "kind":"block", "type":"logic_not_ja" },

        { "kind": "label", "text": "制御" },
        { "kind": "block", "type": "forever_ja" },
        { "kind": "block", "type": "repeat_ja" },
        { "kind": "block", "type": "time_wait_ms", "inputs": { "MS": { "shadow": { "type": "math_number", "fields": { "NUM": 500 } } } } },
        { "kind": "block", "type": "if_simple_ja" },
        { "kind": "block", "type": "if_else_simple_ja" },

        { "kind": "label", "text": "論理・比較" },
        { "kind": "block", "type": "logic_compare" },
        { "kind": "block", "type": "var_compare", "inputs": { "RHS": { "shadow": { "type":"math_number", "fields": { "NUM": 30 } } } } },
        { "kind": "block", "type": "logic_boolean" },

        { "kind": "label", "text": "変数" },
        { "kind": "block", "type": "var_name", "fields": { "VARNAME": "dist" } },
        { "kind": "block", "type": "var_set_by_name" },
        { "kind": "block", "type": "var_get_by_name" },

        { "kind": "label", "text": "表示" },
        { "kind": "block", "type": "print_ja" },

        { "kind": "label", "text": "GPIO" },
        { "kind": "block", "type": "gpio_set", "inputs": { "PIN": { "shadow": { "type": "math_number", "fields": { "NUM": 25 } } } } },

        { "kind": "label", "text": "モータ（自動初期化）" },
        { "kind": "block", "type": "motor_cmd" },

        { "kind": "label", "text": "センサー（超音波・自動）" },
        { "kind": "block", "type": "ultra_read_cm" },

        { "kind": "label", "text": "カラー（VEML6040・自動）" },
        { "kind": "block", "type": "veml_value" },

        { "kind": "label", "text": "ボタン（Start/Stop・自動）" },
        { "kind": "block", "type": "button_state" },

        { "kind": "label", "text": "フラッグ" },
        { "kind": "block", "type": "flag_set" },
        { "kind": "block", "type": "flag_clear" },
        { "kind": "block", "type": "flag_toggle" },
        { "kind": "block", "type": "flag_is_set" },

        { "kind": "label", "text": "値" },
        { "kind": "block", "type": "math_number", "fields": { "NUM": 0 } },
        { "kind": "block", "type": "text" },
        { "kind": "block", "type": "text", "fields": { "TEXT": "hello" } }
      ]
    };

    // ========= 4) ワークスペース =========
    const workspace = Blockly.inject('ws', {
      toolbox, theme: KiddoTheme, trashcan:true, scrollbars:true, renderer:'geras',
      rtl:false, toolboxPosition:'end',
      grid:{ spacing:24, length:3, colour:'#e8ecff', snap:true },
      zoom:{ controls:true, wheel:true, startScale:0.9, maxScale:2, minScale:0.5, pinch:true },
      move:{ scrollbars:{horizontal:false, vertical:true}, drag:true, wheel:true }
    });

    // ========= 5) 生成コード =========
    const $out = document.getElementById('out');
    function genCode(){
      const header = `
from machine import Pin, I2C, time_pulse_us
import time

# ---------------- Motor (2WD) ----------------
M_IN1 = M_IN2 = M_IN3 = M_IN4 = None
M_DEFAULT = (0,1,2,10)  # IN1, IN2, IN3, IN4
def back_right_rotate():
    # 右モータを逆回転 / 左モータ停止
    _ensure_motor()
    # 右: IN1=1, IN2=0（逆） / 左: IN3=0, IN4=0（停止）
    M_IN1.value(1); M_IN2.value(0)
    M_IN3.value(0); M_IN4.value(0)

def back_left_rotate():
    # 左モータを逆回転 / 右モータ停止
    _ensure_motor()
    # 右: IN1=0, IN2=0（停止） / 左: IN3=1, IN4=0（逆）
    M_IN1.value(0); M_IN2.value(0)
    M_IN3.value(1); M_IN4.value(0)

def motor_setup(pin_in1, pin_in2, pin_in3, pin_in4):
    global M_IN1, M_IN2, M_IN3, M_IN4
    M_IN1 = Pin(int(pin_in1), Pin.OUT)
    M_IN2 = Pin(int(pin_in2), Pin.OUT)
    M_IN3 = Pin(int(pin_in3), Pin.OUT)
    M_IN4 = Pin(int(pin_in4), Pin.OUT)
    stopMotors()
def _ensure_motor():
    if any(x is None for x in (M_IN1, M_IN2, M_IN3, M_IN4)):
        motor_setup(*M_DEFAULT)
def forward():  _ensure_motor(); M_IN1.value(1); M_IN2.value(1); M_IN3.value(1); M_IN4.value(1)
def backward(): _ensure_motor(); M_IN1.value(1); M_IN2.value(0); M_IN3.value(1); M_IN4.value(0)
def left():     _ensure_motor(); M_IN1.value(0); M_IN2.value(0); M_IN3.value(1); M_IN4.value(1)
def right():    _ensure_motor(); M_IN1.value(1); M_IN2.value(1); M_IN3.value(0); M_IN4.value(0)
def stopMotors():
    global M_IN1, M_IN2, M_IN3, M_IN4
    if any(x is None for x in (M_IN1, M_IN2, M_IN3, M_IN4)):
        for p in M_DEFAULT:
            try: Pin(p, Pin.OUT).value(0)
            except: pass
    else:
        M_IN1.value(0); M_IN2.value(0); M_IN3.value(0); M_IN4.value(0)

# ---------------- Ultrasonic (HC-SR04) ----------------
U_TRIG = U_ECHO = None
U_DEF_TRIG = 20
U_DEF_ECHO = 21
SPEED_CM_PER_US = 0.0343
def _ensure_ultra():
    global U_TRIG, U_ECHO
    if U_TRIG is None or U_ECHO is None:
        U_TRIG = Pin(U_DEF_TRIG, Pin.OUT)
        U_ECHO = Pin(U_DEF_ECHO, Pin.IN)
        U_TRIG.value(0)
def ultra_read_cm(timeout_us=30000):
    _ensure_ultra()
    U_TRIG.value(0); time.sleep_us(2)
    U_TRIG.value(1); time.sleep_us(10)
    U_TRIG.value(0)
    try:
        dur = time_pulse_us(U_ECHO, 1, timeout_us)
        if dur < 0: return -1
    except Exception:
        return -1
    return (dur * SPEED_CM_PER_US) / 2.0

# ---------------- Buttons (Start/Stop) ----------------
B_START = B_STOP = None
B_DEF_START = 8
B_DEF_STOP  = 9
def _ensure_buttons():
    global B_START, B_STOP
    if B_START is None or B_STOP is None:
        B_START = Pin(B_DEF_START, Pin.IN)
        B_STOP  = Pin(B_DEF_STOP,  Pin.IN)
def button_start(): _ensure_buttons(); return 1 if B_START.value() else 0
def button_stop():  _ensure_buttons(); return 1 if B_STOP.value()  else 0

# ---------------- VEML6040 (RGBW) ----------------
V_I2C=None; V_ADDR=0x10; V_IT_MS=320
V_REG_CONF=0x00; V_REG_RED=0x08; V_REG_GREEN=0x09; V_REG_BLUE=0x0A; V_REG_WHITE=0x0B
V_IT_CODE={40:0x00,80:0x10,160:0x20,320:0x30,640:0x40,1280:0x50}
V_GSENS={40:0.25168,80:0.12584,160:0.06292,320:0.03146,640:0.01573,1280:0.007865}
def _wr16(reg,val): V_I2C.writeto_mem(V_ADDR, reg, bytes((val & 0xFF, (val>>8)&0xFF)))
def _rd16(reg): b=V_I2C.readfrom_mem(V_ADDR, reg, 2); return b[0] | (b[1]<<8)
def _apply_conf():
    conf = V_IT_CODE.get(V_IT_MS,0x30)
    _wr16(V_REG_CONF, conf)
def _ensure_veml():
    global V_I2C
    if V_I2C is None:
      V_I2C=I2C(0, sda=Pin(4), scl=Pin(5), freq=100_000)
      _apply_conf()
def veml_read_raw():
    _ensure_veml()
    r=_rd16(0x08); g=_rd16(0x09); b=_rd16(0x0A); w=_rd16(0x0B)
    return r,g,b,w
def veml_red():   return veml_read_raw()[0]
def veml_green(): return veml_read_raw()[1]
def veml_blue():  return veml_read_raw()[2]
def veml_white(): return veml_read_raw()[3]
def veml_lux():   _,g,_,_=veml_read_raw(); return g*V_GSENS.get(V_IT_MS,0.03146)
def veml_cct():
    r,g,_,_=veml_read_raw()
    if g<=0: return -1
    try: return 4278.6*((r/g)**-1.2455)+0.5
    except Exception: return -1

# ---------------- Flags ----------------
FLAGS = {}
def _flag_set(n):   FLAGS[str(n)] = True
def _flag_clear(n): FLAGS[str(n)] = False
def _flag_toggle(n):
    k = str(n); FLAGS[k] = not FLAGS.get(k, False)
def _flag_get(n):   return FLAGS.get(str(n), False)

`;
      const body = Blockly.Python.workspaceToCode(workspace);
      return header + body;
    }
    document.getElementById('btnGen').addEventListener('click', ()=>{
      const code=genCode();
      document.getElementById('out').textContent = code || "# ブロックを置いてから押してね";
    });

    // ========= 6) シリアルモニター =========
    const $console = document.getElementById('console');
    function consolePush(line){
      if(!line) return;
      const div=document.createElement('div');
      div.className='line';
      div.textContent=line;
      $console.appendChild(div);
      $console.scrollTop=$console.scrollHeight;
      while($console.children.length>300){ $console.removeChild($console.firstChild); }
    }
    document.getElementById('btnConsoleClear')?.addEventListener('click', ()=>{ $console.textContent=''; });

    // ========= 7) Web Serial =========
    let port=null, reader=null, writer=null, _buf='';
    const CTRL_A=0x01, CTRL_B=0x02, CTRL_C=0x03, CTRL_D=0x04;
    const writeBytes = async(b)=> writer.write(b instanceof Uint8Array ? b : new Uint8Array(b));
    const writeText  = async(s)=> writeBytes(new TextEncoder().encode(s));
    const delay = (ms)=> new Promise(r=>setTimeout(r,ms));

    async function attachReader(){
      if(!port) return;
      reader = port.readable.getReader();
      const dec = new TextDecoder();
      (async ()=>{
        try{
          while (port && reader){
            const {value, done} = await reader.read();
            if(done) break;
            if(value){
              const text = dec.decode(value);
              _buf += text;
              const lines = _buf.split(/\r?\n/); _buf = lines.pop();
              lines.forEach(l=>consolePush(l.trim()));
            }
          }
        } catch(e) {
          console.warn('[serial read error]', e);
        } finally {
          try{ reader?.releaseLock(); }catch{}
          reader = null;
          if(_buf){ consolePush(_buf.trim()); _buf=''; }
        }
      })();
    }

    async function attachToPort(p){
      try{
        port=p; await port.open({baudRate:115200});
        writer=port.writable.getWriter();
        document.getElementById('btnStart').disabled=false;
        document.getElementById('btnStop').disabled=false;
        await attachReader();
      }catch(e){
        console.warn('[attach error]', e);
        document.getElementById('btnStart').disabled=true;
        document.getElementById('btnStop').disabled=true;
        try{ writer?.releaseLock(); }catch{}
        writer=null; reader=null; port=null;
      }
    }

    async function connectSerial(){
      try{
        if(!('serial' in navigator)){ alert("このブラウザはWeb Serialに未対応です（Chrome/Edge推奨）"); return; }
        const p=await navigator.serial.requestPort();
        await attachToPort(p);
      }catch(e){
        if(e && e.name==='NotFoundError'){ return; }
        console.warn('[requestPort error]', e);
      }
    }
    document.getElementById('btnConnect').addEventListener('click', connectSerial);

    async function enterRawRepl(){
      await writeBytes(Uint8Array.from([CTRL_C])); await delay(60);
      await writeBytes(Uint8Array.from([CTRL_C])); await delay(120);
      await writeBytes(Uint8Array.from([CTRL_A])); await delay(120);
      await writeText('\r\n'); await delay(60);
    }

    // ▶ スタート：書き込み→main.py 実行（接続は保持）
    async function flashAndRun(){
      if(!writer || !port){ alert("先に『接続』してください"); return; }
      const code=genCode(); if(!code.trim()){ alert("ブロックがありません"); return; }
      const b64=btoa(unescape(encodeURIComponent(code)));
      try{
        await enterRawRepl();
        const script =
`import ubinascii
data = ubinascii.a2b_base64("${b64}")
with open("main.py","wb") as f:
    f.write(data)
print("WROTE", len(data))
`;
        await writeText(script);
        await writeBytes(Uint8Array.from([CTRL_D]));
        await delay(300);
        await writeBytes(Uint8Array.from([CTRL_B]));
        await delay(150);
        await writeBytes(Uint8Array.from([CTRL_D]));
        await delay(300);
        if(!reader){ await attachReader(); }
      }catch(e){
        console.warn('[flash error]', e);
      }
    }
    document.getElementById('btnStart').addEventListener('click', flashAndRun);

    // ■ ストップ：Ctrl-Cで停止＋既定ピンを安全にLOW
    async function stopRunning(){
      if(!writer || !port) return;
      try{
        await writeBytes(Uint8Array.from([CTRL_C]));
        await delay(150);
        const safeOff = `
try:
  from machine import Pin
  for _p in (0,1,2,10):
    try: Pin(_p, Pin.OUT).value(0)
    except: pass
except:
  pass
`;
        await writeText(safeOff);
      }catch(e){
        console.warn('[stop error]', e);
      }
    }
    document.getElementById('btnStop').addEventListener('click', stopRunning);

    // リセット
    document.getElementById('btnReset').addEventListener('click', async ()=>{
      if(!writer){ alert('先に接続してください'); return; }
      await writeBytes(Uint8Array.from([CTRL_D]));
    });

    // 自動再接続
    window.addEventListener('load', async ()=>{
      if(!('serial' in navigator)){ return; }
      try{
        const ports=await navigator.serial.getPorts();
        if(ports.length){ await attachToPort(ports[0]); }
      }catch(e){ console.warn('[auto-connect error]', e); }
    });
    navigator.serial?.addEventListener?.('disconnect', async ()=>{
      document.getElementById('btnStart').disabled=true;
      document.getElementById('btnStop').disabled=true;
      try{ reader && (await reader.cancel()); reader?.releaseLock(); }catch{}
      try{ writer?.releaseLock(); }catch{}
      reader=null; writer=null; port=null;
      consolePush('[device disconnected]');
    });
    navigator.serial?.addEventListener?.('connect', async ()=>{
      try{
        const ports=await navigator.serial.getPorts();
        if(ports.length && !port){ await attachToPort(ports[0]); }
        consolePush('[device connected]');
      }catch(err){ console.warn('[reconnect error]', err); }
    });

    if(!('serial' in navigator)){
      document.getElementById('btnConnect').disabled=true;
      document.getElementById('btnStart').disabled=true;
      document.getElementById('btnStop').disabled=true;
    }
    if(!Blockly.Python){ alert('Python generator が読み込めていません。ネットワーク/読み込み順を確認してください。'); }
  </script>
</body>
</html>
